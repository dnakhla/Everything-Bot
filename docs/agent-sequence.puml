@startuml Agent_Interaction_Sequence
!theme blueprint
title Everything Bot - Multi-Agent Interaction Flow

actor User
participant "Telegram Bot" as TB
participant "Agent Router" as AR
participant "Persona Manager" as PM
participant "Context Manager" as CM
participant "Memory Manager" as MM
participant "Transcription Agent" as TA
participant "Search Agent" as SA
participant "Fact-Check Agent" as FA
participant "OpenAI GPT-4" as GPT
participant "External APIs" as APIs
participant "S3 Storage" as S3

== Message Processing ==
User -> TB: "fact-bot is climate change real?" + voice message
TB -> AR: Route incoming message
AR -> AR: Parse message type and persona

== Persona & Context Setup ==
AR -> PM: Identify persona (fact-bot)
PM -> PM: Load fact-checking persona traits
PM -> CM: Set context for factual analysis
CM -> MM: Retrieve relevant conversation history
MM -> S3: Query past climate discussions
S3 --> MM: Return historical context
MM --> CM: Provide memory context

== Multi-Agent Orchestration ==
CM -> TA: Process voice message
TA -> GPT: Transcribe audio using Whisper
GPT --> TA: Return transcription
TA --> CM: "Is climate change caused by humans?"

CM -> SA: Research climate change evidence
SA -> APIs: Search for recent climate data
APIs --> SA: Scientific papers, IPCC reports
SA -> FA: Verify source credibility
FA -> GPT: Cross-reference multiple sources
GPT --> FA: Fact-check analysis
FA --> SA: Verified factual data
SA --> CM: Compiled research results

== Response Generation ==
CM -> PM: Generate fact-based response
PM -> GPT: Create response with fact-bot persona
note right of GPT
  Persona Instructions:
  - Use scientific evidence
  - Cite credible sources
  - Maintain objective tone
  - Provide data-driven conclusions
end note
GPT --> PM: Persona-styled factual response

== Memory & Storage ==
PM -> MM: Store interaction for future reference
MM -> S3: Save conversation + fact-check results
S3 --> MM: Confirm storage

== Response Delivery ==
PM -> AR: Final response ready
AR -> TB: Send formatted response
TB -> User: Deliver fact-checked answer with sources

== Follow-up Memory Query ==
User -> TB: "memory-bot what did we discuss about climate?"
TB -> AR: Route memory query
AR -> MM: Search conversation history
MM -> S3: Query climate-related discussions
S3 --> MM: Return conversation summaries
MM -> GPT: Summarize historical discussions
GPT --> MM: "You asked about climate change evidence..."
MM -> TB: Deliver memory-based response
TB -> User: "2 weeks ago you asked about climate change..."

note over User, S3
  The system maintains persistent memory across sessions,
  enabling contextual conversations and learning user preferences
end note

@enduml