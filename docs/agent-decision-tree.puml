@startuml Agent_Decision_Tree
!theme toy
title Everything Bot - Agent Selection Decision Tree

start

:Incoming Message;

if (Message Type?) then (Voice Message)
  :Activate Transcription Agent;
  :Process with Whisper API;
  :Convert to text context;
else (Image/Video)
  :Activate Video Analysis Agent;
  :Extract frames with FFmpeg;
  :Analyze with Vision API;
else (Text Message)
  if (Contains Persona Prefix?) then (Yes)
    if (Persona Type?) then (fact-bot)
      :Activate Fact-Check Agent;
      :Research mode with citations;
    elseif (skeptic-bot) then
      :Activate Critical Analysis Agent;
      :Question assumptions;
    elseif (optimist-bot) then
      :Activate Positive Response Agent;
      :Focus on opportunities;
    elseif (conspiracy-bot) then
      :Activate Alternative Perspective Agent;
      :Explore hidden connections;
    elseif (bro-bot) then
      :Activate Casual Explanation Agent;
      :Use simple, friendly language;
    elseif (memory-bot) then
      :Activate Memory Retrieval Agent;
      :Search conversation history;
    else (Custom Persona)
      :Activate Adaptive Persona Agent;
      :Generate custom personality;
    endif
  else (No Persona)
    if (Contains Question Words?) then (Yes)
      :Activate Search Agent;
      :Web research and fact-checking;
    elseif (Mentions Past Conversation?) then (Yes)
      :Activate Memory Agent;
      :Retrieve historical context;
    else (General Chat)
      :Activate Default Conversational Agent;
      :Maintain group chat context;
    endif
  endif
endif

:Context Manager Coordination;
note right
  All agents coordinate through
  the Context Manager to maintain
  conversation coherence
end note

:Memory Manager Integration;
note right
  Every interaction is stored
  for future context and learning
end note

if (Requires External Data?) then (Yes)
  if (Search Query?) then (Yes)
    :Use Serper API;
    :Use Brave Search API;
  elseif (Fact Verification?) then (Yes)
    :Cross-reference sources;
    :Verify with multiple APIs;
  elseif (Reddit Discussion?) then (Yes)
    :Search Reddit communities;
    :Analyze public sentiment;
  endif
else (No External Data)
  :Use cached knowledge;
endif

:Generate Response with OpenAI;

:Apply Persona Styling;

:Store Interaction in S3;

:Send Response to Telegram;

stop

note bottom
  The system uses a hierarchical decision tree where:
  1. Message type determines initial agent selection
  2. Persona prefixes override default behavior
  3. Context managers coordinate between agents
  4. Memory managers maintain long-term persistence
  5. All agents can access external APIs as needed
end note

@enduml